---
title: "Base de Datos del SCN Guatemala"
author: "Renato Vargas"
date: "4/6/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introducción

El Sistema de Cuentas Nacionales de todos los países es una fuente muy valiosa para el análisis de la economía, el ambiente natural y la sociedad. Normalmente, la información de dicho sistema se encuentra organizada en una serie de cuadros de multiple entrada que describen diversas transacciones económicas y saldos contables entre los agentes económicos, consignados en hojas de cálculo (generalmente en el formato .xlsx de Excel). Las magnitudes de este tipo de hojas suponen un reto para los usuarios de la información por la dificultad que supone navegarlas, visualizarlas y hacer consultas puntuales.

Para facilitar el uso de la información que se encuentra dentro del SCN, el Iarna presenta los datos de dichas cuentas en formato de base de datos de tabla única y en esta memoria de cálculo se muestran los pasos utilizados para dicho trabajo y el código del lenguaje estadístico R utilizado para el efecto.

# Preparación de los datos

El Banco de Guatemala ha puesto a disposición los datos de oferta y utilización en su sitio web. Como se mencionó en la introducción estos se encuentran en formato Excel, en el cual cada pestaña corresponde a cuatro cuadros; uno de oferta, uno de utilización, uno de valor agregado y uno de empleo para los años 2013-2019, sea en millones de quetzales a precios corrientes o en millones de quetzales en medidas encadenadas de volumen con año de referencia 2013 (el empleo se encuentra registrado conforme a número de puestros de trabajo).

En un primer paso preparatorio, se selecciona todas las pestañas del archivo al mismo tiempo (utilizando shift y seleccionándolas) y se presiona el botón "separar celdas", el cual remueve la combinación de celdas. Esto permite tener clarol qué celdas contienen los datos necesarios para el procesamiento y cuáles no. Además, en esta etapa también se activa el comando "mostrar" para evitar sorpresas en filas o columnas ocultas. Una vez se ha hecho estas acciones, se guarda y se cierra el documento para que R no tenga problemas para acceder a él durante los siguientes pasos. En este punto para poder tener una referencia a la mano, se puede hacer una copia del archivo el cual no será tocado por R y que se puede mantener abierto.

En el Excel de referencia se sugiere utilizar dos filas vacías, adyacentes a los títulos de columna de los cuadros de oferta y utilización para numerar sucesivamente las columnas. En una se iniciará el conteo desde la primera columna (A) y se terminará la rotulación en la última columna con datos. En la otra fila se iniciará la numeración desde la primera columna que contiene datos (D en este caso) para podernos referir exactamente a las columnas que debamos remover o procesar una vez ingresadas en el ambiente R.

Otro paso importante dentro del ambiente de Excel será revisar que la estructura de los cuadros no cambie de año a año, pues en el procesamiento se desarrollarán rutinas recursivas que permitirán facilitar las tareas repetitivas, pero que dependen de que los datos se encuentren organizados de la misma forma. Este es el caso de los cuadros del SCN de Guatemala, lo cual permite continuar con la siguiente fase.

Habiendo eliminado las combinaciones de datos, se copiará y transpondrá todos los títulos de columna y se copiarán todos los títulos de fila (incluyendo las filas con las numeraciones que fueron creadas anteriormente) y se creará un archivo de Excel (puede ser tan sencillo como un archivo separado por comas) con las clasificaciones crudas cómo aparecen en los cuadros, a las cuales se podrá crear equivalencias para agregar los datos o para eliminar filas y columnas de totales y subtotales redundantes. Se creará una pestaña con los datos de las columnas y otra para los datos de las filas.

Antes de inciciar, como buena práctica se llamarán las librerías necesarias para la sesión y se limpiará el área de trabajo. Estas librerías o paquetes extienden la funcionalidad de R para tareas específicas. Para este procesamiento se utilizan librerías para interactuar con Excel (`readxl` y `openxlsx`) y para dar forma a los datos (`reshape`).

```{r librerias, results="hide"}
# Llamar librerías
library(readxl)
library(openxlsx)
library(reshape2)

# Limpiar el área de trabajo
rm(list = ls())

```

Aunque es posible llamar a cada archivo que se necesite ingresando en la función correspondiente la ruta completa al directorio, es buena práctica cambiar el directorio de trabajo al directorio en donde se encuentran los datos de insumo o un directorio específico de resultados en dónde pueda exportarse directamente cualquier salida que se necesite exportar. Esto permite usar el nombre del archivo directamente sin escribir la ruta completa. Se hace en dos pasos. Primeramente se guarda el directorio en una variable para referencia y en segundo lugar se usa esa variable con la función de cambio de directorio `setwd()`.

```{r workingDirectoryNoShow, eval=FALSE}
# Variable con la ruta y "/" al final
wd <- "C:/ruta/al/directorio/de/datos/"
# Cambiar la ruta de trabajo con la variable anterior
setwd(wd)
```

```{r workingDirectory, echo=FALSE}
# Variable con la ruta y "/" al final
wd <- "C:/Users/renato/GitHub/scn_gt/datos/"
# Cambiar la ruta de trabajo con la variable anterior
setwd(wd)
```

# Leer los datos

## El cuadro de oferta

Para leer la información se recurre a la librería `read_xl` que permite conectar R con el archivo de Excel. Otra librería que es posible utilizar es `openxlsx`, aunque la primera provee resultados más predecibles cuando se encuentra filas o columnas vacías en los datos de Excel y por eso es preferida en este ejercicio. No obstante, solamente se puede leer datos con `read_xl` y por eso se utilizará `openxlsx` para exportar los resultados al final del ejercicio. Esta lectura se hará de manera recursiva para obtener todos los cuadros en una sola función, lo cual se mostrará más adelante. Para ejemplificar la lectura de un solo cuadro, el siguiente código muestra lo necesario para obtener solamente los datos del cuadro de oferta para el año 2013 y colocarlo dentro del objeto de R (o la variable) `oferta_2013`.

```{r leerUnCuadroOferta}
oferta_2013 <- as.matrix(read_excel(
    "GTM_COU_2013-2019.xlsx", 
    range = "'4.1'!D11:DT162", # Nótese que no incluimos la fila de totales
    col_names = FALSE,
    col_types = "numeric",
    progress = TRUE
    ))
```




```{r eliminar}

# Columnas a eliminar con subtotales y totales

# 93	P1 PRODUCCION (PB)	Producción de mercado		SUBTOTAL DE MERCADO
# 98	P1 PRODUCCION (PB)	Producción para uso final propio		SUBTOTAL USO FINAL PROPIO
# 108	P1 PRODUCCION (PB)	Producción no de mercado		SUBTOTAL NO DE MERCADO
# 109	P1 TOTAL PRODUCCION (PB)	
# 112	P7 IMPORTACIONES (CIF)	TOTAL		TOTAL
# 118	D21 IMPUESTOS SOBRE PRODUCTOS	TOTAL		TOTAL
# 121	TOTAL OFERTA (PC)	TOTAL OFERTA (PC)		


```







